# 포팅 매뉴얼

> 아래 설명은 모두 EC2 서버를 기준으로 되어있습니다.

<br><br>

## EC2 기본 설정

아래 과정은 UFW이 활성화되어 있다는 전제하에 진행됩니다.

### 80 포트 허용

1. UFW 구동된 상태에서 80 포트를 추가합니다.
   ```sh
   sudo ufw allow 80
   ```
2. 80 포트가 정상적으로 등록되었는지 확인합니다.
   ```sh
   sudo ufw status numbered
   ```

<br>

### 서버 시간대 설정

추후 디버깅할 때 편리하도록 서버 시간대를 한국으로 설정합니다.

```sh
sudo timedatectl set-timezone Asia/Seoul
```

<br>

### 미러 사이트 변경

각 리전에 맞는 미러사이트를 설정하여, 더 빠르고 안정적으로 패키지 설치 및 관리가 가능하도록 합니다.

1. APT 소스 리스트 파일을 엽니다.
   ```
   sodu vi /etc/apt/sources.list
   ```
2. 미러 사이트를 변경합니다.
   ```
   :%s/{기존미러서버}/{변경할 미러서버}
   ```
   한국에서는 KAIST 또는 KAKAO를 많이 사용하므로 아래 미러 사이트 주소를 참고하시면 됩니다.
   - KAIST: `ftp.kaist.ac.kr`
   - KAKAO: `mirror.kakao.com`

<br>

### 리눅스 업데이트 및 필수 패키지 설치

1. 리눅스 시스템의 패키지 목록을 업데이트하고, 설치된 패키지를 최신 버전으로 업그레이드합니다.
   ```sh
   sudo apt update -y
   sudo apt upgrade -y
   ```
   ※ 새로운 패키지 버전의 정보를 업데이트하고 나서, 해당 정보를 토대로 패키지를 설치해야 하므로 위의 명령어 순서를 준수해주시기 바랍니다.
2. 필수 패키지를 설치합니다.
   ```sh
   sudo apt-get install -y ca-certificates curl gnupg lsb-release
   ```

<br><br>

## Docker 설치 및 설정

### Docker 설치

1. Docker의 공식 GPG 키를 추가할 디렉토리를 생성합니다.
   ```sh
   sudo mkdir -p /etc/apt/keyrings
   ```
2. Docker의 GPG 키 다운로드한 후, 바이너리 형식으로 변환하여 저장합니다.
   ```sh
   curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.png
   ```
3. Docker 저장소를 추가합니다.
   ```sh
   echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
   ```
4. 패키지 목록을 업데이트합니다.
   ```sh
   sudo apt-get update
   ```
5. Docker 패키지를 설치합니다.
   ```sh
   sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
   ```
6. Docker 데몬을 시작하고 부팅 시 자동으로 시작하도록 설정합니다.
   ```sh
   sudo systemctl start docker
   sudo systemctl enable docker
   ```

<br>

### Docker 실행 권한 설정

Docker 실행 권한을 설정하여, Docker 명령을 실행할 때마다 `sudo`를 사용하지 않아도 된다.

1. 현재 사용자를 Docker 그룹에 추가한다.
   ```sh
   sudo usermode -aG docker $USER
   ```
   - 해당 변경 사항은 즉시 반영되지 않고, 기본적으로 다음 로그인시 적용됩니다.  
      ∴ 사용자가 로그아웃하고 다시 로그인해야 새로 추가된 그룹 권한이 적용됩니다.  
      따라서, 로그아웃/로그인 없이 즉시 적용하고 싶다면, 아래 명령어를 실행하여 현재 세션에서 그룹 변경 사항을 반영할 수 있습니다.
     `   netgrp docker`
2. Docker 그룹에 사용자가 제대로 추가되었는지 확인합니다.
   ```sh
   groups $USER
   ```

<br>

### Docker Compose 설정

1. Docker Compose 버전을 확인합니다.
   ```sh
   docker-compose --version
   ```
   만약, `docker-compose` 명령어를 실행할 수 없다면 다음 아래 명령어를 통해 Docker Compose를 설정합니다.
   ```sh
   sudo curl -L "https://github.com/docker/compose/releases/download/v2.6.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
   sudo chmod +x /usr/local/bin/docker-compose
   sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
   ```

<br><br>

## Nginx 및 certbot 설정

### Nginx + certbot Docker Container 정의

certbot을 이용하여 무료로 SSL/TLS 인증서를 발급받은 후, Nginx에 SSL 설정을 하여 HTTPS 통신을 하도록 합니다.

1. Nginx와 certbot 관련 설정 파일을 저장할 디렉토리를 생성합니다.
   ```sh
   mkdir -p ~/newbie/data/nginx
   mkdir -p ~/newbie/data/certbot
   ```
2. `~/newbie/` 디렉토리 안에 Nginx랑 certbot 컨테이너를 정의할 Docker Compose를 정의합니다.

   ```sh
   cd ~/newbie
   vi docker-compose.yml
   ```

   <docker-compose.yml>

   ```yml
   version: '3.8'

    services:
        nginx:
            image: nginx:latest
            restart: unless-stopped
            volumes:
                - ./data/nginx/nginx.conf:/etc/nginx/nginx.conf
                - ./data/certbot/conf:/etc/letsencrypt
                - ./data/certbot/www:/var/www/certbot
            ports:
                - "80:80"
                - "443:443"
            command: "/bin/sh -c 'while :; do sleep 320h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
            environment:
                TZ: Asia/Seoul
            logging:
                options:
                    max-size: "10m"
                    max-file: "1"

        certbot:
            image: certbot/certbot
            restart: unless-stopped
            volumes:
                - ./data/certbot/conf:/etc/letsencrypt
                - ./data/certbot/www:/var/www/certbot
            entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 720h & wait $${!}; done;'"
            environment:
                TZ: Asia/Seoul
            logging:
                options:
                    max-size: "10m"
                    max-file: "1"
   ```

<br>

### Nginx 설정

1. Nginx 설정을 정의합니다.

   ```sh
   cd ~/newbie/data/nginx
   vi nginx.conf
   ```

   <nginx.conf>

   ```conf
   user nginx;
   worker_processes 1;

   error_log /var/log/nginx/error.log warn;
   pid /var/run/nginx.pid;

   events {
      worker_connections 1024;
   }

   http {
      include /etc/nginx/mime.types;
      default_type application/octet-stream;

      log_format main '$remote_addr - $remote_user [$time_local] "$request"'
                     '$status $body_bytes_sent "$http_referer"'
                     '"$http_user_agent" "$http_x_forwarded_for"';

      access_log	/var/log/nginx/access.log main;

      sendfile on;
      keepalive_timeout 65;

      limit_req_zone $binary_remote_addr zone=mylimit:10m rate=1r/s;

      server {
         listen 80;

         server_name {DOMAIN NAME};
         server_tokens off;

         location /.well-known/acme-challenge/ {
         root /var/www/certbot;
         }

         location / {
               return 308 https://$host$request_uri;
         }
      }


      server {
         listen 443 ssl;

         server_name {DOMAIN NAME};
         server_tokens off;

         ssl_certificate /etc/letsencrypt/live/{DOMAIN NAME}/fullchain.pem;
         ssl_certificate_key /etc/letsencrypt/live/{DOMAIN NAME}/privkey.pem;

         include /etc/letsencrypt/options-ssl-nginx.conf;

         ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

         location / {
               limit_req zone=mylimit burst=1000 nodelay;

               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_set_header X-Forwarded-Proto $scheme;

               add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
               add_header Pragma "no-cache";
               add_header Expires "0";

               add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization';
               add_header 'Access-Control-Allow-Credentials' 'true';
         }
      }
   }
   ```

### SSL 인증서 발급 및 적용

1. SSL 인증서를 발급하는 스크립트 파일을 생성합니다.

   ```sh
   cd ~/newbie
   vi init-letsencrypt.sh
   ```

   <init-letsencrypt.sh>

   ```sh
   #!/bin/bash

   # 1. check docker-compose installation
   if ! [ -x "$(command -v docker-compose)" ]; then
      echo 'Error: docker-compose is not installed.' >&2
      exit 1
   fi


   # 2. set domain, RSA key size, data path, email address, test mode
   domains=({DOMAIN NAME})
   rsa_key_size=4096
   data_path="./data/certbot"
   email=""
   staging=0


   # 3. check for existing data and ask the user if they want to overwrite it
   if [ -d "$data_path" ]; then
      read -p "Existing data found for $domains. Continue and replace existing certificate? (y/N)" decision
      if [ "$decision" != "Y" ] && [ "$decision" != "y" ]; then
         exit
      fi
   fi


   # 4. download recommended TSL configuration file
   if [ ! -e "$data_path/conf/options-ssl-nginx.conf" ] || [ ! -e "$data_path/conf/ssl-dhparams.pem" ]; then
      echo "### Downloading recommended TLS parameters ..."

      mkdir -p "$data_path/conf"

      curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf > "$data_path/conf/options-ssl-nginx.conf"
      curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot/certbot/ssl-dhparams.pem > "$data_path/conf/ssl-dhparams.pem"

      echo
   fi


   # 5. create temporary dummy certificate
   echo "### Creating dummy certificate for $domains ..."

   path="/etc/letsencrypt/live/$domains"

   mkdir -p "$data_path/conf/live/$domains"

   docker-compose run --rm --entrypoint "\
      openssl req -x509 -nodes -newkey rsa:$rsa_key_size -days 1\
      -keyout '$path/privkey.pem' \
      -out '$path/fullchain.pem' \
      -subj '/CN=localhost'" certbot

   echo


   # 6. start nginx
   echo "### Starting nginx ..."

   docker-compose up --force-recreate -d nginx

   echo


   # 7. delete temporary dummy certificate
   echo "### Deleting dummy certificate for $domains ..."

   docker-compose run --rm --entrypoint "\
      rm -Rf /etc/letsencrypt/live/$domains && \
      rm -Rf /etc/letsencrypt/archive/$domains && \
      rm -Rf /etc/letsencrypt/renewal/$domains.conf" certbot

   echo


   # 8. Request Let's Encrypt certificate
   echo "### Requesting Let's Encrypt certificate for $domains ..."

   # 8-1. set domain arguments
   domain_args=""
   for domain in "${domains[@]}"; do
      domain_args="$domain_args -d $domain"
   done

   # 8-2. set email arguments
   email_arg="--register-unsafely-without-email"
   if [ -n "$email" ]; then
      email_arg="--email $email"
   fi

   # 8-3. set staging arguments
   staging_arg=""
   if [ $staging -ne 0 ]; then
      staging_arg="--staging"
   fi

   docker-compose run --rm --entrypoint "\
      certbot certonly --webroot \
      -w /var/www/certbot \
      $staging_arg \
      $email_arg \
      $domain_args \
      --rsa-key-size $rsa_key_size \
      --agree-tos \
      --force-renewal" certbot

   echo


   # 9. reload nginx
   echo "### Reloading nginx ..."
   docker-compose exec nginx nginx -s reload
   ```

2. 스크립트 파일에 실행 권한을 부여하고 실행하여 SSL 인증서를 발급받습니다.
   ```sh
   chmod +x init-letsencrypt.sh
   ./init-letsencrypt.sh
   ```

<br><br>

## NEWBIE 프로젝트 배포

NEWBIE 프로젝트는 React 1 + Spring Cloud Gateway 1 + Spring Boot 9 + FastAPI 1 + RabbitMQ 1 + Redis 3 + MySQL 4 + + MongoDB 3으로 이루어져 있으며, 해당 프로그램을 모두 실행해야 정상적으로 작동됩니다.  
아래 내용은 해당 git 프로젝트를 clone 받았다는 전제하에 진행됩니다. 😉  
(참고로, `~/newbie` 밑에 git 프로젝트를 clone 받았다 가정하고 진행하겠습니다.)

<br>

**PACKAGE VERSION**  
Package Name | Version
--- | ---
docker | 27.3.1
node.js | 20.18.0
java | openjdk-17.0.11

<br>

**PORT**  
Project Name | Docker Container Name | Port
--- | --- | ---
React | frontend | 3000
Jenkins | jenkins | 8080
Spring Cloud Gateway | backend-gateway | 8080
Spring Boot for Authentication | backend-auth | 8080
Spring Boot for User | backend-auth | 8080
Spring Boot for Mypage | backend-mypage | 8080
Spring Boot for Baseball | backend-baseball | 8080
Spring Boot for Chatting with User | backend-chat | 8080
Spring Boot for Chatbot with Baseball Dictionary | backend-chatbot | 8080
Spring Boot for Photo Card Store | backend-cardstore | 8080
Spring Boot for Board | backend-board | 8080
Spirng Boot for Mileage | backend-mileage | 8080
FastAPI for Club Recommendation | backend-club-recommend | 8080
RabbitMQ | rabbitmq | 4369, 5671-5672
Redis for Baseball | redis-baseball | 6379
Redis for Chatting with User | redis-chat | 6379
Redis for Chatbot with Baseball Dictionary | redis-chatbot | 6379
MySQL for Authentication | mysql-auth | 3306
MySQL for User | mysql-user | 3306
MySQL for Baseball | mysql-baseball | 3306
MySQL for Board | mysql-board | 3306
MongoDB for Mypage | mongodb-mypage | 27017
MongoDB for Photo Card Store | mongodb-cardstore | 27017
MongoDB for Mileage | mongodb-mileage | 27017

<br>

### 환경변수 관리

1. 프로젝트와 관련된 환경변수를 관리하는 파일을 생성합니다.

   ```sh
   cd ~/newbie
   vi .env
   ```

   <.env>

   ```env
   # <BE>
    SERVER_DOMAIN=https://{DOMAIN_NAME}


    # server
    SERVER_PATH=8080/api/v1

    AUTH_SERVER_DOMAIN=http://backend-auth
    USER_SERVER_DOMAIN=http://backend-user
    MYPAGE_SERVER_DOMAIN=http://backend-mypage
    BASEBALL_SERVER_DOMAIN=http://backend-baseball
    CHAT_SERVER_DOMAIN=http://backend-chat
    CHATBOT_SERVER_DOMAIN=http://backend-chatbot
    CARDSTORE_SERVER_DOMAIN=http://backend-cardstore
    BOARD_SERVER_DOMAIN=http://backend-board

    CLUB_RECOMMEND_SERVER_DOMAIN=http://backend-club-recommend
    MILAGE_SERVER_DOMAIN=http://backend-mileage


    # swagger
    CARDSTORE_API_DOCS_PATH=/v3/api-docs


    # MySQL
    MYSQL_DDL_AUTO=update
    MYSQL_USERNAME={MYSQL_USERNAME}

    AUTH_MYSQL_URL=jdbc:mysql://mysql-auth:3306/auth
    AUTH_MYSQL_PASSWORD={AUTH_MYSQL_PASSWORD}

    USER_MYSQL_URL=jdbc:mysql://mysql-user:3306/user
    USER_MYSQL_PASSWORD={USER_MYSQL_PASSWORD}

    BASEBALL_MYSQL_URL=jdbc:mysql://mysql-baseball:3306/baseball
    BASEBALL_MYSQL_PASSWORD={BASEBALL_MYSQL_PASSWORD}

    BOARD_MYSQL_URL=jdbc:mysql://mysql-board:3306/board
    BOARD_MYSQL_PASSWORD={BOARD_MYSQL_PASSWORD}


    # mongoDB
    MONGODB_USERNAME={MONGODB_USERNAME}

    MYPAGE_MONGODB_HOST=mongodb-mypage
    MYPAGE_MONGODB_PORT=27017
    MYPAGE_MONGODB_DATABASE=mypage
    MYPAGE_MONGODB_PASSWORD={MYPAGE_MONGODB_PASSWORD}

    CARDSTORE_MONGODB_HOST=mongodb-cardstore
    CARDSTORE_MONGODB_PORT=27017
    CARDSTORE_MONGODB_DATABASE=cardstore
    CARDSTORE_MONGODB_PASSWORD={CARDSTORE_MONGODB_PASSWORD}

    MILEAGE_MONGODB_HOST=mongodb-mileage
    MILEAGE_MONGODB_PORT=27017
    MILEAGE_MONGODB_DATABASE=mileage
    MILEAGE_MONGODB_PASSWORD={MILEAGE_MONGODB_PASSWORD}


    # redis
    BASEBALL_REDIS_HOST=redis-baseball
    BASEBALL_REDIS_PORT=6379
    BASEBALL_REDIS_TIME=600000

    CHAT_REDIS_HOST=redis-chat
    CHAT_REDIS_PORT=6379

    CHATBOT_REDIS_HOST=redis-chatbot
    CHATBOT_REDIS_PORT=6379


    # rabbitMQ
    RABBITMQ_HOST=rabbitmq
    RABBITMQ_PORT=5672
    RABBITMQ_USERNAME={RABBITMQ_USERNAME}
    RABBITMQ_PASSWORD={RABBITMQ_PASSWORD}

    RABBITMQ_CLUB_RECOMMEND_QUEUE_NAME=club-recommend-queue
    RABBITMQ_CLUB_RECOMMEND_EXCHANGE_NAME=club-recommend-exchange
    RABBITMQ_CLUB_RECOMMEND_ROUTING_KEY=club-recommend

    RABBITMQ_PLAYER_QUEUE_NAME=player-queue
    RABBITMQ_PLAYER_ROUTING_KEY=player

    RABBITMQ_AUTH_BOARD_QUEUE_NAME=auth-board-queue
    RABBITMQ_AUTH_BOARD_EXCHANGE_NAME=auth-board-exchange
    RABBITMQ_AUTH_BOARD_ROUTING_KEY=auth-board

    RABBITMQ_BOARD_MILEAGE_QUEUE_NAME=mileage-board-queue
    RABBITMQ_BOARD_MILEAGE_ROUTING_KEY=mileage-board

    RABBITMQ_MILEAGE_QUEUE_NAME=mileage-queue
    RABBITMQ_MILEAGE_EXCHANGE_NAME=mileage-exchange
    RABBITMQ_MILEAGE_ROUTING_KEY=mileage


    # JWT
    JWT={JWT_SECRET_KEY}


    # KAKAO
    KAKAO_CLIENT_ID={KAKAO_CLIENT_ID}
    KAKAO_GRANT_TYPE={KAKAO_GRANT_TYPE}
    KAKAO_REDIRECT_URI=https://{DOMAIN_NAME}/auth/redirect?platform=kakao
    KAKAO_RESTAPI={KAKAO_CLIENT_SECRET}


    # NAVER OCR
    NAVER_OCR_API_KEY={NAVER_OCR_API_KEY}
    NAVER_OCR_API_URL={NAVER_OCR_API_URL}


    # YouTube API
    YOUTUBE_API_KEY={YOUTUBE_API_KEY}


    # AWS S3
    HO_AWS_ACCESS_KEY={AWS_ACCESS_KEY_1}
    HO_AWS_SECRET_KEY={AWS_SECRET_KEY_1}
    HO_AWS_S3_BUCKET={AWS_SECRET_S3_BUCKET_1}

    HA_AWS_ACCESS_KEY={AWS_ACCESS_KEY_2}
    HA_AWS_SECRET_KEY={AWS_SECRET_KEY_2}
    HA_AWS_S3_BUCKET={AWS_SECRET_S3_BUCKET_2}
    HA_AWS_BOARD_FOLDER={AWS_BOARD_FOLDER_NAME}
    HA_AWS_REGION={AWS_REGION}


    # OPENAI API KEY
    OPENAI_API_KEY={OPENAI_API_KEY}


    # FRONT-END
    VITE_API_BASE_URL=https://{DOMAIN_NAME}
    VITE_API_SOCKET_URL=wss://{DOMAIN_NAME}

    VITE_WEATHER_DATA_API_KEY={WEATHER_DATA_API_KEY}
    VITE_GET_WEATHER_URL=https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtFcst

   ```

   - 위의 상황은 AWS S3를 2개 사용하였지만, 상황에 따라 1개만 사용하셔도 괜찮습니다.
   - NAVER OCR, YouTube API, OpenAI API, 기상청 단기예보(Weather Data API)는 다음 아래 사이트를 참고하셔서 API를 신청 후 관련된 변수를 넣으시면 됩니다.
     - NAVER OCR: https://www.ncloud.com/product/aiService/ocr
     - YouTube API: https://developers.google.com/youtube/v3?hl=ko
     - OpenAI: https://openai.com
     - 기상청 단기예보: https://www.data.go.kr/iim/api/selectAPIAcountView.do

<br>

### React(Front-End) Docker Image 생성

1. React 프로젝트의 최상위 폴더로 이동합니다.
   ```sh
   cd ~/newbie/S11P21B303/frontend
   ```
2. React 프로젝트를 npm을 사용하여 필요한 패키지를 설치한 후 빌드합니다.
   ```sh
   npm install & npm run build
   ```
3. 빌드된 결과물을 토대로 React Docker Image를 생성합니다.
   ```sh
   docker build -t frontend:latest -f ./Dockerfile .
   ```

<br>

### Spring Boot(Backe-End) Docker Image 생성

Spring Boot for Authentication 프로젝트를 기준으로 Docker Image를 생성하도록 하겠습니다.  
다른 Spring Cloud Gateway 및 Spring Boot 프로젝트도 동일하게 진행하시면 됩니다.

1. Spring Boot for Authentication 프로젝트의 최상위 폴더로 이동합니다.
   ```sh
   cd ~/newbie/S11P21B303/backend/auth
   ```
2. Spring Boot 프로젝트르 gradle을 사용하여 테스트 및 빌드합니다.
   ```sh
   ./gradlew clean build --no-daemon
   ```
3. 빌드된 결과물을 토대로 Spring Boot for Authentication Docker Image를 생성합니다.
   ```sh
   docker build -t backend-auth:latest -f ./Dockerfile .
   ```

<br>

### NEWBIE 프로젝트 Docker Container 생성 및 실행

1. NEWBIE 프로젝트와 관련된 Docker Container를 관리하기 위해서 앞서 생성한 Docker Compose를 수정합니다.

   ```sh
   cd ~/dontouch
   vi docker-compose.yml
   ```

   <docker-compose.yml>

   ```yml
   services:
     nginx:
       image: nginx:latest
       restart: unless-stopped
       volumes:
         - ./data/nginx/nginx.conf:/etc/nginx/nginx.conf
         - ./data/certbot/conf:/etc/letsencrypt
         - ./data/certbot/www:/var/www/certbot
       ports:
         - "80:80"
         - "443:443"
       command: '/bin/sh -c ''while :; do sleep 320h & wait $${!}; nginx -s reload; done & nginx -g "daemon off;"'''
       environment:
         TZ: Asia/Seoul
       logging:
         driver: "json-file"
         options:
           max-size: "10m"
           max-file: "1"

     certbot:
       image: certbot/certbot
       restart: unless-stopped
       volumes:
         - ./data/certbot/conf:/etc/letsencrypt
         - ./data/certbot/www:/var/www/certbot
       entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 720h & wait $${!}; done;'"
       environment:
         TZ: Asia/Seoul
       logging:
         driver: "json-file"
         options:
           max-size: "10m"
           max-file: "1"

     jenkins:
       build:
         context: ./data/jenkins/.
         dockerfile: Dockerfile
       restart: unless-stopped
       volumes:
         - jenkins_home:/var/jenkins_home
         - ./data/jenkins:/var/jenkins_shared
         - /var/run/docker.sock:/var/run/docker.sock
         - /usr/local/bin/docker-compose:/usr/local/bin/docker-compose
         - /usr/bin/docker:/usr/bin/docker
         - /home/ubuntu/newbie:/home/ubuntu/newbie
       environment:
         TZ: Asia/Seoul
         JENKINS_OPTS: --prefix=/jenkins
         # server
         AUTH_SERVER_URL: ${SERVER_DOMAIN}/api-auth
         USER_SERVER_URL: ${SERVER_DOMAIN}/api-user
         MYPAGE_SERVER_URL: ${SERVER_DOMAIN}/api-mypage
         BASEBALL_SERVER_URL: ${SERVER_DOMAIN}/api-baseball
         CHATBOT_SERVER_URL: ${SERVER_DOMAIN}/api-chatbot
         CARDSTORE_SERVER_URL: ${SERVER_DOMAIN}/api-cardstore
         BOARD_SERVER_URL: ${SERVER_DOMAIN}/api-board
         SERVER_PATH: ${SERVER_PATH}
         AUTH_SERVER_DOMAIN: ${AUTH_SERVER_DOMAIN}:8080
         USER_SERVER_DOMAIN: ${USER_SERVER_DOMAIN}:8080
         MYPAGE_SERVER_DOMAIN: ${MYPAGE_SERVER_DOMAIN}:8080
         BASEBALL_SERVER_DOMAIN: ${BASEBALL_SERVER_DOMAIN}:8080
         CHAT_SERVER_DOMAIN: ${CHAT_SERVER_DOMAIN}:8080
         CHATBOT_SERVER_DOMAIN: ${CHATBOT_SERVER_DOMAIN}:8080
         CARDSTORE_SERVER_DOMAIN: ${CARDSTORE_SERVER_DOMAIN}:8080
         BOARD_SERVER_DOMAIN: ${BOARD_SERVER_DOMAIN}:8080
         CLUB_RECOMMEND_SERVER_DOMAIN: ${CLUB_RECOMMEND_SERVER_DOMAIN}:8000/recommend
         MILAGE_SERVER_DOMAIN: ${MILAGE_SERVER_DOMAIN}:8080
         # swagger
         CARDSTORE_API_DOCS_PATH: ${CARDSTORE_API_DOCS_PATH}
         # MySQL
         MYSQL_DDL_AUTO: ${MYSQL_DDL_AUTO}
         MYSQL_USERNAME: ${MYSQL_USERNAME}
         AUTH_MYSQL_URL: ${AUTH_MYSQL_URL}
         AUTH_MYSQL_PASSWORD: ${AUTH_MYSQL_PASSWORD}
         USER_MYSQL_URL: ${USER_MYSQL_URL}
         USER_MYSQL_PASSWORD: ${USER_MYSQL_PASSWORD}
         BASEBALL_MYSQL_URL: ${BASEBALL_MYSQL_URL}
         BASEBALL_MYSQL_PASSWORD: ${BASEBALL_MYSQL_PASSWORD}
         BOARD_MYSQL_URL: ${BOARD_MYSQL_URL}
         BOARD_MYSQL_PASSWORD: ${BOARD_MYSQL_PASSWORD}
         # mongoDB
         MONGODB_USERNAME: ${MONGODB_USERNAME}
         MYPAGE_MONGODB_HOST: ${MYPAGE_MONGODB_HOST}
         MYPAGE_MONGODB_PORT: ${MYPAGE_MONGODB_PORT}
         MYPAGE_MONGODB_DATABASE: ${MYPAGE_MONGODB_DATABASE}
         MYPAGE_MONGODB_PASSWORD: ${MYPAGE_MONGODB_PASSWORD}
         CARDSTORE_MONGODB_HOST: ${CARDSTORE_MONGODB_HOST}
         CARDSTORE_MONGODB_PORT: ${CARDSTORE_MONGODB_PORT}
         CARDSTORE_MONGODB_DATABASE: ${CARDSTORE_MONGODB_DATABASE}
         CARDSTORE_MONGODB_PASSWORD: ${CARDSTORE_MONGODB_PASSWORD}
         MILEAGE_MONGODB_HOST: ${MILEAGE_MONGODB_HOST}
         MILEAGE_MONGODB_PORT: ${MILEAGE_MONGODB_PORT}
         MILEAGE_MONGODB_DATABASE: ${MILEAGE_MONGODB_DATABASE}
         MILEAGE_MONGODB_PASSWORD: ${MILEAGE_MONGODB_PASSWORD}
         # redis
         BASEBALL_REDIS_HOST: ${BASEBALL_REDIS_HOST}
         BASEBALL_REDIS_PORT: ${BASEBALL_REDIS_PORT}
         BASEBALL_REDIS_TIME: ${BASEBALL_REDIS_TIME}
         CHAT_REDIS_HOST: ${CHAT_REDIS_HOST}
         CHAT_REDIS_PORT: ${CHAT_REDIS_PORT}
         CHATBOT_REDIS_HOST: ${CHATBOT_REDIS_HOST}
         CHATBOT_REDIS_PORT: ${CHATBOT_REDIS_PORT}
         # rabbitMQ
         RABBITMQ_HOST: ${RABBITMQ_HOST}
         RABBITMQ_PORT: ${RABBITMQ_PORT}
         RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
         RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
         RABBITMQ_CLUB_RECOMMEND_QUEUE_NAME: ${RABBITMQ_CLUB_RECOMMEND_QUEUE_NAME}
         RABBITMQ_CLUB_RECOMMEND_EXCHANGE_NAME: ${RABBITMQ_CLUB_RECOMMEND_EXCHANGE_NAME}
         RABBITMQ_CLUB_RECOMMEND_ROUTING_KEY: ${RABBITMQ_CLUB_RECOMMEND_ROUTING_KEY}
         RABBITMQ_PLAYER_QUEUE_NAME: ${RABBITMQ_PLAYER_QUEUE_NAME}
         RABBITMQ_PLAYER_ROUTING_KEY: ${RABBITMQ_PLAYER_ROUTING_KEY}
         RABBITMQ_MILEAGE_QUEUE_NAME: ${RABBITMQ_MILEAGE_QUEUE_NAME}
         RABBITMQ_MILEAGE_EXCHANGE_NAME: ${RABBITMQ_MILEAGE_EXCHANGE_NAME}
         RABBITMQ_MILEAGE_ROUTING_KEY: ${RABBITMQ_MILEAGE_ROUTING_KEY}
         RABBITMQ_BOARD_MILEAGE_QUEUE_NAME: ${RABBITMQ_BOARD_MILEAGE_QUEUE_NAME}
         RABBITMQ_BOARD_MILEAGE_ROUTING_KEY: ${RABBITMQ_BOARD_MILEAGE_ROUTING_KEY}
         RABBITMQ_AUTH_BOARD_QUEUE_NAME: ${RABBITMQ_AUTH_BOARD_QUEUE_NAME}
         RABBITMQ_AUTH_BOARD_EXCHANGE_NAME: ${RABBITMQ_AUTH_BOARD_EXCHANGE_NAME}
         RABBITMQ_AUTH_BOARD_ROUTING_KEY: ${RABBITMQ_AUTH_BOARD_ROUTING_KEY}
         # JWT
         JWT: ${JWT}
         # KAKAO
         KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
         KAKAO_GRANT_TYPE: ${KAKAO_GRANT_TYPE}
         KAKAO_REDIRECT_URI: ${KAKAO_REDIRECT_URI}
         KAKAO_RESTAPI: ${KAKAO_RESTAPI}
         # NAVER OCR
         NAVER_OCR_API_URL: ${NAVER_OCR_API_URL}
         NAVER_OCR_API_KEY: ${NAVER_OCR_API_KEY}
         # YouTube API
         YOUTUBE_API_KEY: ${YOUTUBE_API_KEY}
         # AWS S3
         HO_AWS_ACCESS_KEY: ${HO_AWS_ACCESS_KEY}
         HO_AWS_SECRET_KEY: ${HO_AWS_SECRET_KEY}
         HO_AWS_S3_BUCKET: ${HO_AWS_S3_BUCKET}
         HA_AWS_ACCESS_KEY: ${HA_AWS_ACCESS_KEY}
         HA_AWS_SECRET_KEY: ${HA_AWS_SECRET_KEY}
         HA_AWS_S3_BUCKET: ${HA_AWS_S3_BUCKET}
         HA_AWS_REGION: ${HA_AWS_REGION}
         HA_AWS_BOARD_FOLDER: ${HA_AWS_BOARD_FOLDER}
         # OPENAPI API KEY
         OPENAI_API_KEY: ${OPENAI_API_KEY}
         # FRONTEND
         VITE_API_BASE_URL: ${VITE_API_BASE_URL}
         VITE_API_SOCKET_URL: ${VITE_API_SOCKET_URL}
         VITE_KAKAO_REST_API: ${KAKAO_RESTAPI}
         VITE_KAKAO_REDIRECT_URI: ${KAKAO_REDIRECT_URI}
         VITE_WEATHER_DATA_API_KEY: ${VITE_WEATHER_DATA_API_KEY}
         VITE_GET_WEATHER_URL: ${VITE_GET_WEATHER_URL}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     rabbitmq:
       image: rabbitmq:3-management
       restart: unless-stopped
       environment:
         TZ: Asia/Seoul
         RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME}
         RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     redis-baseball:
       image: redis
       restart: unless-stopped
       volumes:
         - ./data/redis/baseball:/data
       environment:
         TZ: Asia/Seoul
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     redis-chat:
       image: redis
       restart: unless-stopped
       volumes:
         - ./data/redis/chat:/data
       environment:
         TZ: Asia/Seoul
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     redis-chatbot:
       image: redis
       restart: unless-stopped
       volumes:
         - ./data/redis/chatbot:/data
       environment:
         TZ: Asia/Seoul
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     mysql-auth:
       image: mysql
       restart: unless-stopped
       volumes:
         - ./data/mysql/auth:/var/lib/mysql
       environment:
         TZ: Asia/Seoul
         MYSQL_ROOT_PASSWORD: { AUTH_MYSQL_ROOT_PASSWORD }
         MYSQL_DATABASE: auth
         MYSQL_USER: ${MYSQL_USERNAME}
         MYSQL_PASSWORD: ${AUTH_MYSQL_PASSWORD}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     mysql-user:
       image: mysql
       restart: unless-stopped
       volumes:
         - ./data/mysql/user:/var/lib/mysql
       environment:
         TZ: Asia/Seoul
         MYSQL_ROOT_PASSWORD: { USER_MYSQL_ROOT_PASSWORD }
         MYSQL_DATABASE: user
         MYSQL_USER: ${MYSQL_USERNAME}
         MYSQL_PASSWORD: ${USER_MYSQL_PASSWORD}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     mysql-baseball:
       image: mysql
       restart: unless-stopped
       volumes:
         - ./data/mysql/baseball:/var/lib/mysql
       environment:
         TZ: Asia/Seoul
         MYSQL_ROOT_PASSWORD: { BASEBALL_MYSQL_ROOT_PASSWORD }
         MYSQL_DATABASE: baseball
         MYSQL_USER: ${MYSQL_USERNAME}
         MYSQL_PASSWORD: ${BASEBALL_MYSQL_PASSWORD}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     mysql-board:
       image: mysql
       restart: unless-stopped
       volumes:
         - ./data/mysql/board:/var/lib/mysql
       environment:
         TZ: Asia/Seoul
         MYSQL_ROOT_PASSWORD: { BOARD_MYSQL_ROOT_PASSWORD }
         MYSQL_DATABASE: board
         MYSQL_USER: ${MYSQL_USERNAME}
         MYSQL_PASSWORD: ${BOARD_MYSQL_PASSWORD}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     mongodb-mypage:
       image: mongo
       restart: unless-stopped
       volumes:
         - ./data/mongodb/mypage:/data/db
       environment:
         TZ: Asia/Seoul
         MONGO_INITDB_ROOT_USERNAME: { MONGODB_USERNAME }
         MONGO_INITDB_ROOT_PASSWORD: { MYPAGE_MONGODB_PASSWORD }
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     mongodb-cardstore:
       image: mongo
       restart: unless-stopped
       ports:
         - "27017:27017"
       volumes:
         - ./data/mongodb/cardstore:/data/db
       environment:
         TZ: Asia/Seoul
         MONGO_INITDB_ROOT_USERNAME: { MONGODB_USERNAME }
         MONGO_INITDB_ROOT_PASSWORD: { CARDSTORE_MONGODB_PASSWORD }
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     mongodb-mileage:
       image: mongo
       restart: unless-stopped
       volumes:
         - ./data/mongodb/mileage:/data/db
       environment:
         TZ: Asia/Seoul
         MONGO_INITDB_ROOT_USERNAME: { MONGODB_USERNAME }
         MONGO_INITDB_ROOT_PASSWORD: { MILEAGE_MONGODB_PASSWORD }
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     frontend:
       image: frontend:latest
       restart: unless-stopped
       environment:
         TZ: Asia/Seoul
         MODE_ENV: production
         VITE_API_BASE_URL: ${VITE_API_BASE_URL}
         VITE_API_SOCKET_URL: ${VITE_API_SOCKET_URL}
         VITE_KAKAO_REST_API: ${KAKAO_RESTAPI}
         VITE_KAKAO_REDIRECT_URI: ${KAKAO_REDIRECT_URI}
         VITE_WEATHER_DATA_API_KEY: ${VITE_WEATHER_DATA_API_KEY}
         VITE_GET_WEATHER_URL: ${VITE_GET_WEATHER_URL}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-gateway:
       image: backend-gateway:latest
       restart: unless-stopped
       environment:
         TZ: Asia/Seoul
         # server
         AUTH_SERVER_DOMAIN: ${AUTH_SERVER_DOMAIN}:8080
         USER_SERVER_DOMAIN: ${USER_SERVER_DOMAIN}:8080
         MYPAGE_SERVER_DOMAIN: ${MYPAGE_SERVER_DOMAIN}:8080
         BASEBALL_SERVER_DOMAIN: ${BASEBALL_SERVER_DOMAIN}:8080
         CHAT_SERVER_DOMAIN: ${CHAT_SERVER_DOMAIN}:8080
         CHATBOT_SERVER_DOMAIN: ${CHATBOT_SERVER_DOMAIN}:8080
         CARDSTORE_SERVER_DOMAIN: ${CARDSTORE_SERVER_DOMAIN}:8080
         BOARD_SERVER_DOMAIN: ${BOARD_SERVER_DOMAIN}:8080
         # JWT
         JWT: ${JWT}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-auth:
       image: backend-auth:latest
       restart: unless-stopped
       environment:
         TZ: Asia/Seoul
         # server
         AUTH_SERVER_URL: ${SERVER_DOMAIN}/api-auth
         USER_SERVER_DOMAIN: ${USER_SERVER_DOMAIN}:8080
         # JWT
         JWT: ${JWT}
         # rabbitMQ
         RABBITMQ_HOST: ${RABBITMQ_HOST}
         RABBITMQ_PORT: ${RABBITMQ_PORT}
         RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
         RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
         RABBITMQ_AUTH_BOARD_QUEUE_NAME: ${RABBITMQ_AUTH_BOARD_QUEUE_NAME}
         RABBITMQ_AUTH_BOARD_EXCHANGE_NAME: ${RABBITMQ_AUTH_BOARD_EXCHANGE_NAME}
         RABBITMQ_AUTH_BOARD_ROUTING_KEY: ${RABBITMQ_AUTH_BOARD_ROUTING_KEY}
         # MySQL
         AUTH_MYSQL_URL: ${AUTH_MYSQL_URL}
         MYSQL_USERNAME: ${MYSQL_USERNAME}
         AUTH_MYSQL_PASSWORD: ${AUTH_MYSQL_PASSWORD}
         # KAKAO
         KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
         KAKAO_GRANT_TYPE: ${KAKAO_GRANT_TYPE}
         KAKAO_REDIRECT_URI: ${KAKAO_REDIRECT_URI}
         KAKAO_RESTAPI: ${KAKAO_RESTAPI}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-user:
       image: backend-user:latest
       restart: unless-stopped
       environment:
         TZ: Asia/Seoul
         # server
         USER_SERVER_URL: ${SERVER_DOMAIN}/api-user
         # MySQL
         MYSQL_DDL_AUTO: ${MYSQL_DDL_AUTO}
         USER_MYSQL_URL: ${USER_MYSQL_URL}
         MYSQL_USERNAME: ${MYSQL_USERNAME}
         USER_MYSQL_PASSWORD: ${USER_MYSQL_PASSWORD}
         # AWS S3
         HO_AWS_ACCESS_KEY: ${HO_AWS_ACCESS_KEY}
         HO_AWS_SECRET_KEY: ${HO_AWS_SECRET_KEY}
         HO_AWS_S3_BUCKET: ${HO_AWS_S3_BUCKET}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-mypage:
       image: backend-mypage:latest
       restart: unless-stopped
       environment:
         TZ: Asia/Seoul
         # server
         MYPAGE_SERVER_URL: ${SERVER_DOMAIN}/api-mypage
         CLUB_RECOMMEND_SERVER_DOMAIN: ${CLUB_RECOMMEND_SERVER_DOMAIN}:8000/recommend
         # mongoDB
         MONGODB_USERNAME: ${MONGODB_USERNAME}
         MYPAGE_MONGODB_HOST: ${MYPAGE_MONGODB_HOST}
         MYPAGE_MONGODB_PORT: ${MYPAGE_MONGODB_PORT}
         MYPAGE_MONGODB_DATABASE: ${MYPAGE_MONGODB_DATABASE}
         MYPAGE_MONGODB_PASSWORD: ${MYPAGE_MONGODB_PASSWORD}
         # rabbitMQ
         RABBITMQ_HOST: ${RABBITMQ_HOST}
         RABBITMQ_PORT: ${RABBITMQ_PORT}
         RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
         RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
         RABBITMQ_CLUB_RECOMMEND_QUEUE_NAME: ${RABBITMQ_CLUB_RECOMMEND_QUEUE_NAME}
         RABBITMQ_CLUB_RECOMMEND_EXCHANGE_NAME: ${RABBITMQ_CLUB_RECOMMEND_EXCHANGE_NAME}
         RABBITMQ_CLUB_RECOMMEND_ROUTING_KEY: ${RABBITMQ_CLUB_RECOMMEND_ROUTING_KEY}
         # NAVER OCR
         NAVER_OCR_API_URL: ${NAVER_OCR_API_URL}
         NAVER_OCR_API_KEY: ${NAVER_OCR_API_KEY}
         # AWS S3
         HA_AWS_ACCESS_KEY: ${HA_AWS_ACCESS_KEY}
         HA_AWS_SECRET_KEY: ${HA_AWS_SECRET_KEY}
         HA_AWS_S3_BUCKET: ${HA_AWS_S3_BUCKET}
         HA_AWS_REGION: ${HA_AWS_REGION}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-baseball:
       image: backend-baseball:latest
       restart: unless-stopped
       environment:
         TZ: Asia/Seoul
         # server
         BASEBALL_SERVER_URL: ${SERVER_DOMAIN}/api-baseball
         # MySQL
         MYSQL_DDL_AUTO: ${MYSQL_DDL_AUTO}
         BASEBALL_MYSQL_URL: ${BASEBALL_MYSQL_URL}
         MYSQL_USERNAME: ${MYSQL_USERNAME}
         BASEBALL_MYSQL_PASSWORD: ${BASEBALL_MYSQL_PASSWORD}
         # redis
         BASEBALL_REDIS_HOST: ${BASEBALL_REDIS_HOST}
         BASEBALL_REDIS_PORT: ${BASEBALL_REDIS_PORT}
         BASEBALL_REDIS_TIME: ${BASEBALL_REDIS_TIME}
         # rabbitMQ
         RABBITMQ_HOST: ${RABBITMQ_HOST}
         RABBITMQ_PORT: ${RABBITMQ_PORT}
         RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
         RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
         # YouTube API
         YOUTUBE_API_KEY: ${YOUTUBE_API_KEY}
         # AWS S3
         HO_AWS_ACCESS_KEY: ${HO_AWS_ACCESS_KEY}
         HO_AWS_SECRET_KEY: ${HO_AWS_SECRET_KEY}
         HO_AWS_S3_BUCKET: ${HO_AWS_S3_BUCKET}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-chat:
       image: backend-chat:latest
       restart: unless-stopped
       environment:
         TZ: Asia/Seoul
         # redis
         CHAT_REDIS_HOST: ${CHAT_REDIS_HOST}
         CHAT_REDIS_PORT: ${CHAT_REDIS_PORT}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-chatbot:
       image: backend-chatbot:latest
       restart: unless-stopped
       environment:
         TZ: Asia/Seoul
         # server
         CHATBOT_SERVER_URL: ${SERVER_DOMAIN}/api-chatbot
         # redis
         CHATBOT_REDIS_HOST: ${CHATBOT_REDIS_HOST}
         CHATBOT_REDIS_PORT: ${CHATBOT_REDIS_PORT}
         # OPENAI API KEY
         OPENAI_API_KEY: ${OPENAI_API_KEY}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-cardstore:
       image: backend-cardstore:latest
       restart: unless-stopped
       environment:
         TZ: Asia/Seoul
         # server
         CARDSTORE_SERVER_URL: ${SERVER_DOMAIN}/api-cardstore
         SERVER_PATH: ${SERVER_PATH}
         MILAGE_SERVER_DOMAIN: ${MILAGE_SERVER_DOMAIN}
         # swagger
         CARDSTORE_API_DOCS_PATH: ${CARDSTORE_API_DOCS_PATH}
         # rabbitmq
         RABBITMQ_HOST: ${RABBITMQ_HOST}
         RABBITMQ_PORT: ${RABBITMQ_PORT}
         RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
         RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
         RABBITMQ_PLAYER_QUEUE_NAME: ${RABBITMQ_PLAYER_QUEUE_NAME}
         RABBITMQ_PLAYER_ROUTING_KEY: ${RABBITMQ_PLAYER_ROUTING_KEY}
         RABBITMQ_MILEAGE_QUEUE_NAME: ${RABBITMQ_MILEAGE_QUEUE_NAME}
         RABBITMQ_MILEAGE_EXCHANGE_NAME: ${RABBITMQ_MILEAGE_EXCHANGE_NAME}
         RABBITMQ_MILEAGE_ROUTING_KEY: ${RABBITMQ_MILEAGE_ROUTING_KEY}
         # mongoDB
         MONGODB_USERNAME: ${MONGODB_USERNAME}
         CARDSTORE_MONGODB_HOST: ${CARDSTORE_MONGODB_HOST}
         CARDSTORE_MONGODB_PORT: ${CARDSTORE_MONGODB_PORT}
         CARDSTORE_MONGODB_DATABASE: ${CARDSTORE_MONGODB_DATABASE}
         CARDSTORE_MONGODB_PASSWORD: ${CARDSTORE_MONGODB_PASSWORD}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-board:
       image: backend-board:latest
       restart: unless-stopped
       environment:
         TZ: Asia/Seoul
         # server
         BOARD_SERVER_URL: ${SERVER_DOMAIN}/api-board
         # rabbitMQ
         RABBITMQ_HOST: ${RABBITMQ_HOST}
         RABBITMQ_PORT: ${RABBITMQ_PORT}
         RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
         RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
         RABBITMQ_BOARD_MILEAGE_QUEUE_NAME: ${RABBITMQ_BOARD_MILEAGE_QUEUE_NAME}
         RABBITMQ_MILEAGE_EXCHANGE_NAME: ${RABBITMQ_MILEAGE_EXCHANGE_NAME}
         RABBITMQ_BOARD_MILEAGE_ROUTING_KEY: ${RABBITMQ_BOARD_MILEAGE_ROUTING_KEY}
         RABBITMQ_AUTH_BOARD_QUEUE_NAME: ${RABBITMQ_AUTH_BOARD_QUEUE_NAME}
         RABBITMQ_AUTH_BOARD_ROUTING_KEY: ${RABBITMQ_AUTH_BOARD_ROUTING_KEY}
         # MySQL
         MYSQL_DDL_AUTO: ${MYSQL_DDL_AUTO}
         BOARD_MYSQL_URL: ${BOARD_MYSQL_URL}
         MYSQL_USERNAME: ${MYSQL_USERNAME}
         BOARD_MYSQL_PASSWORD: ${BOARD_MYSQL_PASSWORD}
         # AWS S3
         HA_AWS_ACCESS_KEY: ${HA_AWS_ACCESS_KEY}
         HA_AWS_SECRET_KEY: ${HA_AWS_SECRET_KEY}
         HA_AWS_S3_BUCKET: ${HA_AWS_S3_BUCKET}
         HA_AWS_REGION: ${HA_AWS_REGION}
         HA_AWS_BOARD_FOLDER: ${HA_AWS_BOARD_FOLDER}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-club-recommend:
       image: backend-club-recommend:latest
       restart: unless-stopped
       expose:
         - "8000"
       environment:
         TZ: Asia/Seoul
         ALLOWED_ORIGIN: ${SERVER_DOMAIN}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-mileage:
       image: backend-mileage:latest
       restart: unless-stopped
       environment:
         TZ: Asia/Seoul
         # rabbitmq
         RABBITMQ_HOST: ${RABBITMQ_HOST}
         RABBITMQ_PORT: ${RABBITMQ_PORT}
         RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
         RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
         RABBITMQ_MILEAGE_QUEUE_NAME: ${RABBITMQ_MILEAGE_QUEUE_NAME}
         RABBITMQ_BOARD_MILEAGE_QUEUE_NAME: ${RABBITMQ_BOARD_MILEAGE_QUEUE_NAME}
         RABBITMQ_MILEAGE_EXCHANGE_NAME: ${RABBITMQ_MILEAGE_EXCHANGE_NAME}
         RABBITMQ_MILEAGE_ROUTING_KEY: ${RABBITMQ_MILEAGE_ROUTING_KEY}
         RABBITMQ_BOARD_MILEAGE_ROUTING_KEY: ${RABBITMQ_BOARD_MILEAGE_ROUTING_KEY}
         # mongoDB
         MONGODB_USERNAME: ${MONGODB_USERNAME}
         MILEAGE_MONGODB_HOST: ${MILEAGE_MONGODB_HOST}
         MILEAGE_MONGODB_PORT: ${MILEAGE_MONGODB_PORT}
         MILEAGE_MONGODB_DATABASE: ${MILEAGE_MONGODB_DATABASE}
         MILEAGE_MONGODB_PASSWORD: ${MILEAGE_MONGODB_PASSWORD}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

   volumes:
     jenkins_home:
   ```

2. React 및 public으로 실행할 Spring Boot에 대해서 Nginx에서 설정해줍니다.

   ```sh
   cd ~/newbie/data/nginx
   vi nginx.conf
   ```

   <nginx.conf>

   ```conf
   user nginx;
   worker_processes 1;

   error_log /var/log/nginx/error.log warn;
   pid /var/run/nginx.pid;

   events {
      worker_connections 1024;
   }

   http {
      include /etc/nginx/mime.types;
      default_type application/octet-stream;

      log_format main '$remote_addr - $remote_user [$time_local] "$request"'
                     '$status $body_bytes_sent "$http_referer"'
                     '"$http_user_agent" "$http_x_forwarded_for"';

      access_log	/var/log/nginx/access.log main;

      sendfile on;
      keepalive_timeout 65;

      limit_req_zone $binary_remote_addr zone=mylimit:10m rate=1r/s;

      upstream jenkins {
         server jenkins:8080;
      }

      upstream backend-gateway {
         server backend-gateway:8080;
      }

      server {
         listen 80;

         server_name {DOMAIN NAME};
         server_tokens off;

         location /.well-known/acme-challenge/ {
         root /var/www/certbot;
         }

         location / {
               return 308 https://$host$request_uri;
         }
      }


      server {
         listen 443 ssl;

         server_name {DOMAIN NAME};
         server_tokens off;

         ssl_certificate /etc/letsencrypt/live/{DOMAIN NAME}/fullchain.pem;
         ssl_certificate_key /etc/letsencrypt/live/{DOMAIN NAME}/privkey.pem;

         include /etc/letsencrypt/options-ssl-nginx.conf;

         ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

         location / {
               limit_req zone=mylimit burst=1000 nodelay;

               proxy_pass http://frontend:3000;

               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_set_header X-Forwarded-Proto $scheme;

               add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
               add_header Pragma "no-cache";
               add_header Expires "0";

               add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization';
               add_header 'Access-Control-Allow-Credentials' 'true';
         }

         location /jenkins {
               proxy_pass http://jenkins/jenkins;

               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_set_header X-Forwarded-Proto $scheme;
               proxy_set_header X-Forwarded-Port 443;
         }

         location /api/v1 {
               proxy_pass http://backend-gateway;

               proxy_http_version 1.1;

               proxy_set_header Upgrade $http_upgrade;
               proxy_set_header Connection "Upgrade";
               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_set_header X-Forwarded-Proto $scheme;
               proxy_set_header X-Forwarded-Port 443;

               proxy_read_timeout 3600;
               proxy_send_timeout 3600;
               proxy_connect_timeout 3600;
         }
      }
   }
   ```

3. MongoDB Docker Container를 실행한 후, wontouch에만 접근 권한이 있는 사용자를 생성합니다.

MongoDB for Mypage를 기준으로 Docker Image를 생성하도록 하겠습니다.  
다른 MongoDB도 동일하게 진행하시면 됩니다.

**DATABSE**
Docker Container Name | Database Name
--- | ---
MongoDB for Mypage | mypage
MongoDB for Photo Card Store | cardstore
MongoDB for Mileage | mileage

```sh
# MongoDB Docker Container 생성 및 실행
docker-compose up -d mongodb

# MongoDB shell 실행
docker-compose exec -it mongodb mongosh -u root -p

# MongoDB user 생성
test> use {DATABSE_NAME}
{DATABASE_NAME}> db.createUser({user: "{MONGODB USERNAME}", pwd: "{MONGODB PASSWORD}" roles: ["readWrite"]})

# user 생성되었는지 확인
{DATABASE_NAME}> db.getUsers()

{DATABASE_NAME}> exit
```

4. MySQL Docker Container를 생성 및 실행합니다.  
   (Spring Boot의 JPA를 통해서 MySQL의 테이블을 생성하기 때문입니다.)
   ```sh
   docker-compose up -d mysql-auth mysql-user mysql-baseball mysql-board
   ```
5. 그 외 나머지 Docker Container를 생성 및 실행합니다.
   ```sh
   docker-compose up -d nginx certbot jenkins frontend backend-gateway backend-auth backend-user backend-mypage backend-baseball backend-chat backend-chatbot backend-cardstore backend-board backend-club-recommend backend-mileage rabbitmq mongodb-mypage mongodb-cardstore mogodb-mileage redis-baseball redis-chat redis-chatbot
   ```
